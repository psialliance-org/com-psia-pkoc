name: iOS ï¿½ TestFlight

on:
  push:
    branches: [ main ]
    paths:
      - 'ios/**'
      - '.github/workflows/ios-testflight-release.yml'
  workflow_dispatch:

concurrency:
  group: ios-testflight-release
  cancel-in-progress: true

env:
  TEAM_ID: LJ99BF5CNX
  BUNDLE_ID: com.elatec.pkoc
  SCHEME: PSIAExperienceApp
  PROJECT: PSIAExperienceApp.xcodeproj

jobs:
  build-and-upload:
    runs-on: macos-15
    defaults:
      run:
        working-directory: ios

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode 16.4
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      - name: Import signing certificate (p12)
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPSTORE_CERTIFICATES_FILE_BASE64 }}
          p12-password: ${{ secrets.APPSTORE_CERTIFICATES_PASSWORD }}

      - name: Download provisioning profiles (App Store)
        uses: apple-actions/download-provisioning-profiles@v4
        with:
          bundle-id: ${{ env.BUNDLE_ID }}
          profile-type: IOS_APP_STORE
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: Bump build number
        run: |
          set -euo pipefail
          SETTINGS=$(xcodebuild -showBuildSettings -project "$PROJECT" -scheme "$SCHEME" 2>/dev/null)
          PLIST_PATH=$(printf "%s\n" "$SETTINGS" | awk '/INFOPLIST_FILE/ {print $3; exit}')
          /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string $GITHUB_RUN_NUMBER" "$PLIST_PATH"

      - name: Archive (Release)
        run: |
            set -euo pipefail
            xcodebuild \
              -project "$PROJECT" \
              -scheme "$SCHEME" \
              -configuration Release \
              -archivePath build/App.xcarchive \
              -destination 'generic/platform=iOS' \
              clean archive

      - name: Create ExportOptions.plist
        run: |
          set -euo pipefail

          profiles_dir="$HOME/Library/MobileDevice/Provisioning Profiles"

          # Find the installed App Store profile name for com.elatec.pkoc
          find_profile_name()
          {
              local bundle_id="$1"
              local team_id="${TEAM_ID}"

              while IFS= read -r -d '' f
              do
                  plist="$(security cms -D -i "$f" 2>/dev/null || true)"
                  [[ -z "$plist" ]] && continue

                  # Skip Ad Hoc / dev
                  isAdHoc="$(/usr/libexec/PlistBuddy -c 'Print :ProvisionsAllDevices' /dev/stdin <<<"$plist" 2>/dev/null || true)"
                  [[ "$isAdHoc" == "true" ]] && continue

                  app_id="$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:application-identifier' /dev/stdin <<<"$plist" 2>/dev/null || true)"
                  expected="${team_id}.${bundle_id}"

                  if [[ "$app_id" == "$expected" ]]
                  then
                      /usr/libexec/PlistBuddy -c 'Print :Name' /dev/stdin <<<"$plist"
                      return 0
                  fi
              done < <(find "$profiles_dir" -name '*.mobileprovision' -print0)

              return 1
          }

          APP_PROFILE_NAME="$(find_profile_name "${BUNDLE_ID}")" || {
            echo "Failed to resolve App Store profile name for ${BUNDLE_ID}" >&2
            exit 1
          }

          mkdir -p build
          cat > build/ExportOptions.plist <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>teamID</key><string>${TEAM_ID}</string>
            <key>signingStyle</key><string>manual</string>
            <key>signingCertificate</key><string>Apple Distribution</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key><string>${APP_PROFILE_NAME}</string>
            </dict>
            <key>uploadSymbols</key><true/>
          </dict>
          </plist>
          PLIST

      - name: Export .ipa
        id: export
        run: |
          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportPath build \
            -exportOptionsPlist build/ExportOptions.plist
          echo "ipa=$(ls build/*.ipa | head -n1)" >> "$GITHUB_OUTPUT"

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v3
        with:
          app-path: ${{ steps.export.outputs.ipa }}
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}