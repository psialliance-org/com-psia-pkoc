name: iOS - Build & Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ios-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      ios: ${{ steps.filter.outputs.ios }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            ios:
              - 'ios/**'
              - '.github/workflows/ios-build-test.yml'

  build-test-ios:
    name: iOS — Build & Test
    runs-on: macos-15
    needs: detect
    if: needs.detect.outputs.ios == 'true'
    defaults:
      run:
        shell: bash
        working-directory: ios
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v5

      - name: Setup Xcode 16.4
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      - name: Cache SwiftPM & DerivedData
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/.swiftpm
            ios/derived_data
          key: ${{ runner.os }}-xcode-16.4-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-xcode-16.4-spm-

      - name: Resolve Swift Package Dependencies
        run: |
          set -euo pipefail
          xcodebuild \
            -resolvePackageDependencies \
            -project PSIAExperienceApp.xcodeproj \
            -scheme PSIAExperienceApp

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: swift
          build-mode: manual

      - name: Build for Testing (no clean, fast flags)
        run: |
          set -euo pipefail
          xcodebuild \
            -project PSIAExperienceApp.xcodeproj \
            -scheme PSIAExperienceAppTests \
            -derivedDataPath derived_data \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,OS=latest,name=iPhone 16' \
            -parallelizeTargets \
            -parallel-testing-enabled YES \
            -parallel-testing-worker-count 4 \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            build-for-testing

      - name: Test without Building
        run: |
          set -euo pipefail
          xcodebuild \
            -project PSIAExperienceApp.xcodeproj \
            -scheme PSIAExperienceAppTests \
            -derivedDataPath derived_data \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,OS=latest,name=iPhone 16' \
            -parallel-testing-enabled YES \
            -parallel-testing-worker-count 4 \
            test-without-building

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  ci:
    name: CI — iOS
    runs-on: ubuntu-latest
    needs: [build-test-ios, detect]
    if: ${{ always() }}
    steps:
      - name: Aggregate result
        run: |
          if [ "${{ needs.detect.outputs.ios }}" != "true" ]; then
            echo "No iOS changes — passing CI."
            exit 0
          fi
          if [ "${{ needs.build-test-ios.result }}" = "success" ]; then
            echo "iOS build passed."
            exit 0
          else
            echo "iOS build failed: ${{ needs.build-test-ios.result }}"
            exit 1
